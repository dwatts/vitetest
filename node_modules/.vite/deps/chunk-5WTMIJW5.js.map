{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/support/FetchAssociatedFeatureLayer.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.27/esri/copyright.txt for details.\n*/\nimport{id as t}from\"../../kernel.js\";import r from\"../../request.js\";import{throwIfAbortError as e}from\"../../core/promiseUtils.js\";import a from\"../FeatureLayer.js\";import n from\"../../portal/Portal.js\";import s from\"../../portal/PortalItem.js\";class i{constructor(t,r,e,a){this._parsedUrl=t,this._portalItem=r,this._apiKey=e,this.signal=a,this._rootDocument=null;const n=this._parsedUrl?.path.match(/^(.*)\\/SceneServer\\/layers\\/([\\d]*)\\/?$/i);n&&(this._urlParts={root:n[1],layerId:parseInt(n[2],10)})}async fetch(){if(!this._urlParts)return null;const t=this._portalItem??await this._portalItemFromServiceItemId();if(null==t)return this._loadFromUrl();const r=await this._findAndLoadRelatedPortalItem(t);return null==r?null:this._loadFeatureLayerFromPortalItem(r)}async fetchPortalItem(){if(!this._urlParts)return null;const t=this._portalItem??await this._portalItemFromServiceItemId();return null==t?null:this._findAndLoadRelatedPortalItem(t)}async _fetchRootDocument(){if(null!=this._rootDocument)return this._rootDocument;if(null==this._urlParts)return this._rootDocument={},{};const t={query:{f:\"json\",token:this._apiKey},responseType:\"json\",signal:this.signal},e=`${this._urlParts.root}/SceneServer`;try{const a=await r(e,t);this._rootDocument=a.data}catch{this._rootDocument={}}return this._rootDocument}async _fetchServiceOwningPortalUrl(){const a=this._parsedUrl?.path,n=a?t?.findServerInfo(a):null;if(n?.owningSystemUrl)return n.owningSystemUrl;const s=a?a.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\":null;try{const t=(await r(s,{query:{f:\"json\"},responseType:\"json\",signal:this.signal})).data.owningSystemUrl;if(t)return t}catch(i){e(i)}return null}async _findAndLoadRelatedPortalItem(t){try{return(await t.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:this.signal})).find((t=>\"Feature Service\"===t.type))||null}catch(r){return e(r),null}}async _loadFeatureLayerFromPortalItem(t){await t.load({signal:this.signal});const r=await this._findMatchingAssociatedSublayerUrl(t.url??\"\");return new a({url:r,portalItem:t}).load({signal:this.signal})}async _loadFromUrl(){const t=await this._findMatchingAssociatedSublayerUrl(`${this._urlParts?.root}/FeatureServer`);return new a({url:t}).load({signal:this.signal})}async _findMatchingAssociatedSublayerUrl(t){const e=t.replace(/^(.*FeatureServer)(\\/[\\d]*\\/?)?$/i,\"$1\"),a=this._urlParts?.layerId,n=this._fetchRootDocument(),s=t=>{const a={query:{f:\"json\"},responseType:\"json\",authMode:t,signal:this.signal};return r(e,a)},i=s(\"anonymous\").catch((()=>s(\"no-prompt\"))),[o,l]=await Promise.all([i,n]),c=l&&l.layers,u=o.data&&o.data.layers;if(!Array.isArray(u))throw new Error(\"expected layers array\");if(Array.isArray(c))for(let r=0;r<Math.min(c.length,u.length);r++){if(c[r].id===a)return`${e}/${u[r].id}`}else if(null!=a&&a<u.length)return`${e}/${u[a].id}`;throw new Error(\"could not find matching associated sublayer\")}async _portalItemFromServiceItemId(){const t=(await this._fetchRootDocument()).serviceItemId;if(!t)return null;const r=new s({id:t,apiKey:this._apiKey}),a=await this._fetchServiceOwningPortalUrl();null!=a&&(r.portal=new n({url:a}));try{return r.load({signal:this.signal})}catch(i){return e(i),null}}}export{i as FetchAssociatedFeatureLayer};\n"],
  "mappings": "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",
  "names": ["n", "i", "t", "a", "j"]
}
